{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack - Personal Finance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="{% static 'finance/layout.css' %}">
    <style>
        .ocr-instructions { background:#f8f9fa; padding:15px; border-radius:10px; margin:15px 0; border-left:5px solid #3498db; }
        .ocr-instructions ol { margin:15px 0; }
        .ocr-instructions li { margin:8px 0; font-size:15px; }
        .spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top:2px solid transparent; border-radius:50%; animation:spin 1s linear infinite; margin-left:8px; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .ocr-preview canvas { max-width:100%; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); border:2px dashed #ddd; }
        #canvasHint { color:#7f8c8d; margin-top:10px; font-style:italic; }
        .hidden { display: none; }
        .notification { position:fixed; top:20px; right:20px; padding:15px 25px; border-radius:8px; color:white; font-weight:500; z-index:1000; opacity:0; transition:all 0.3s; }
        .notification.success { background:#27ae60; }
        .notification.error { background:#e74c3c; }
        .notification.show { opacity:1; transform:translateY(0); }
        .chart-card { height: 380px; position: relative; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .charts-container { grid-template-columns: 1fr; }
            .nav-tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- HEADER -->
    <div class="header" style="position:relative; padding: 25px 30px;">
        <h1>FinTrack</h1>
        <div style="position:absolute; top:20px; right:30px; display:flex; align-items:center; gap:15px; color:white; font-size:16px;">
            <span>Welcome, <strong>{{ user.username|title }}</strong>!</span>
            <form action="{% url 'logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger" style="padding:8px 16px; font-size:14px; margin:0;">Logout</button>
            </form>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab(this, 'dashboard')">Dashboard</button>
        <button class="nav-tab" onclick="showTab(this, 'add-expense')">Add Expense</button>
        <button class="nav-tab" onclick="showTab(this, 'borrow-lend')">Borrow & Lend</button>
        <button class="nav-tab" onclick="showTab(this, 'transactions')">Transactions</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card income"><div class="stat-value" id="totalIncome">₹0.00</div><div class="stat-label">Total Income</div></div>
            <div class="stat-card expense"><div class="stat-value" id="totalExpense">₹0.00</div><div class="stat-label">Total Expenses</div></div>
            <div class="stat-card savings"><div class="stat-value" id="totalSavings">₹0.00</div><div class="stat-label">Net Savings</div></div>
            <div class="stat-card"><div class="stat-value" id="borrowLendBalance">₹0.00</div><div class="stat-label">Borrow/Lend Balance</div></div>
        </div>
        <div class="charts-container">
            <div class="chart-card"><canvas id="expenseChart"></canvas></div>
            <div class="chart-card"><canvas id="trendChart"></canvas></div>
        </div>
    </div>

    <!-- ADD EXPENSE - NOTES REMOVED -->
    <div id="add-expense" class="tab-content">
        <div class="form-container">
            <h2>Add New Transaction</h2>
            <form id="expenseForm">
                {% csrf_token %}
                <div class="form-grid">
                    <!-- Notes field completely removed -->
                    <div class="form-group"><label>Item Name</label><input type="text" id="expenseItem" required></div>
                    <div class="form-group"><label>Amount (₹)</label><input type="number" id="expenseAmount" step="0.01" min="0.01" required></div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="expenseType" required>
                            <option value="">Select Type</option>
                            <option value="Expense">Expense</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expenseCategory" required><option value="">Select Category</option></select>
                    </div>
                    <div class="form-group"><label>Date</label><input type="date" id="expenseDate" required></div>
                </div>
                <button type="submit" class="btn btn-primary">Add Transaction</button>
            </form>

            <br><br>
            <h3>Upload Bill & Auto-Extract (OCR)</h3>
            <div class="ocr-instructions">
                <ol>
                    <li>Upload bill image</li>
                    <li>Draw 1 box over items, 1 over amounts</li>
                    <li>Click Process → Auto-add!</li>
                </ol>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div style="margin-bottom: 10px;">
                    <input type="file" id="imageUpload" name="image" accept="image/*" required style="padding:10px;">
                    <p style="color: #7f8c8d; font-size: 13px; margin: 5px 0 0 0; font-style: italic;">
                        ⚠️ Maximum file size: 1MB
                    </p>
                </div>
                <canvas id="canvas" class="hidden"></canvas>
                <p id="canvasHint">Image appears here. Draw rectangles.</p>
                <button type="submit" id="processBtn" class="btn btn-primary">Process Image</button>
            </form>
        </div>
    </div>

    <!-- BORROW & LEND - REASON REMOVED -->
    <div id="borrow-lend" class="tab-content">
        <h2>Borrow & Lend Money</h2>
        <form id="borrowLendForm">
            {% csrf_token %}
            <div class="form-grid">
                <!-- Reason field removed -->
                <div class="form-group"><label>Person Name</label><input type="text" id="personName" required></div>
                <div class="form-group"><label>Amount (₹)</label><input type="number" id="blAmount" step="0.01" min="0.01" required></div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="blType" required>
                        <option value="">Select</option>
                        <option value="lent">Lent (They Owe Me)</option>
                        <option value="borrowed">Borrowed (I Owe)</option>
                    </select>
                </div>
                <div class="form-group"><label>Date</label><input type="date" id="blDate" required></div>
                <div class="form-group"><label>Due Date (Optional)</label><input type="date" id="dueDate"></div>
            </div>
            <button type="submit" class="btn btn-primary">Add Record</button>
        </form>

        <div class="transactions-table" style="margin-top:40px;">
            <table class="table">
                <thead><tr><th>Person</th><th>Amount</th><th>Type</th><th>Date</th><th>Due</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="borrowLendTable"></tbody>
            </table>
        </div>
    </div>

    <!-- TRANSACTIONS -->
    <div id="transactions" class="tab-content">
        <table class="table">
            <thead><tr><th>Item</th><th>Amount</th><th>Type</th><th>Category</th><th>Date</th><th>Actions</th></tr></thead>
            <tbody id="transactionsTable">
                {% for expense in expenses %}
                <tr id="row-{{ expense.id }}">
                    <td class="editable" data-field="item_name">{{ expense.item_name }}</td>
                    <td class="editable" data-field="amount">₹{{ expense.amount|floatformat:2 }}</td>
                    <td class="editable" data-field="type">{{ expense.type }}</td>
                    <td class="editable" data-field="category">{{ expense.category }}</td>
                    <td class="editable" data-field="date">{{ expense.date }}</td>
                    <td>
                        <button class="btn btn-primary" style="padding:5px 10px;font-size:12px;" onclick="enableEdit({{ expense.id }})">Edit</button>
                        <button class="btn btn-danger" style="padding:5px 10px;font-size:12px;" onclick="deleteExpense({{ expense.id }})">Delete</button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" style="text-align:center;padding:50px;color:#999;">No transactions yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expenseDate').value = today;
    document.getElementById('blDate').value = today;
    document.getElementById('blDate').min = today;
    document.getElementById('dueDate').min = today;

    document.getElementById('blDate').addEventListener('change', function() {
        document.getElementById('dueDate').min = this.value;
        if (document.getElementById('dueDate').value && document.getElementById('dueDate').value < this.value) {
            document.getElementById('dueDate').value = '';
        }
    });

    // DONUT CHART - LEGEND TOP + % INSIDE + BIG TOOLTIP
    const expenseChart = new Chart(document.getElementById('expenseChart'), {
        type: 'doughnut',
        data: { 
            labels: [], 
            datasets: [{ 
                data: [], 
                backgroundColor: ['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899','#6366f1','#14b8a6'], 
                borderWidth: 3, 
                borderColor: '#fff', 
                hoverOffset: 20 
            }] 
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'top', 
                    labels: { padding: 20, usePointStyle: true, font: { size: 13, weight: 'bold' }}
                },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const value = ctx.parsed;
                            const total = ctx.dataset.data.reduce((a,b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${ctx.label}: ₹${value.toFixed(2)} (${percentage}%)`;
                        }
                    },
                    titleFont: { size: 16, weight: 'bold' },
                    bodyFont: { size: 18, weight: 'bold' },
                    padding: 14,
                    cornerRadius: 10,
                    backgroundColor: 'rgba(0,0,0,0.85)'
                }
            }
        },
        plugins: [{
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                const dataset = chart.data.datasets[0];
                const total = dataset.data.reduce((a,b) => a + b, 0);
                chart.getDatasetMeta(0).data.forEach((arc, i) => {
                    if (total === 0) return;
                    const value = dataset.data[i];
                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                    const centerX = arc.x;
                    const centerY = arc.y;
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 15px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(percentage, centerX, centerY);
                });
            }
        }]
    });

    const trendChart = new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Income', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4, pointRadius: 6, pointHoverRadius: 8, fill: true },
            { label: 'Expense', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4, pointRadius: 6, pointHoverRadius: 8, fill: true }
        ]},
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top', labels: { usePointStyle: true, font: { size: 14 } }}},
            scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }}, x: { grid: { display: false }}}
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showTab(button, tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        button.classList.add('active');
        if (tabName === 'borrow-lend') loadLendBorrowRecords();
        if (tabName === 'transactions') loadTransactions();
    }

    function showNotification(msg, type = 'success') {
        const n = document.createElement('div');
        n.className = `notification ${type}`;
        n.textContent = msg;
        document.body.appendChild(n);
        setTimeout(() => n.classList.add('show'), 100);
        setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 300); }, 3000);
    }

    function updateCharts() {
        fetch("/get_chart_data/").then(r => r.json()).then(d => {
            expenseChart.data.labels = Object.keys(d.categories);
            expenseChart.data.datasets[0].data = Object.values(d.categories);
            expenseChart.update();
            trendChart.data.labels = d.months;
            trendChart.data.datasets[0].data = d.income;
            trendChart.data.datasets[1].data = d.expense;
            trendChart.update();
        });
    }

    function updateDashboardStats() {
        fetch("/get_totals/").then(r => r.json()).then(d => {
            document.getElementById("totalIncome").textContent = `₹${d.total_income.toFixed(2)}`;
            document.getElementById("totalExpense").textContent = `₹${d.total_expense.toFixed(2)}`;
            document.getElementById("totalSavings").textContent = `₹${d.total_savings.toFixed(2)}`;
        });
        fetch("/lend-borrow/").then(r => r.json()).then(d => {
            const balance = d.records.filter(r => r.status === 'pending').reduce((s, r) => r.type === 'lent' ? s + r.amount : s - r.amount, 0);
            document.getElementById("borrowLendBalance").textContent = balance >= 0 ? `+₹${balance.toFixed(2)}` : `-₹${Math.abs(balance).toFixed(2)}`;
        });
    }

    // Expense Form Submit

        // LIMIT ITEM NAME TO 30 CHARACTERS (FRONTEND)
document.getElementById('expenseItem').addEventListener('input', function(e) {
    if (this.value.length > 50) {
        this.value = this.value.slice(0, 50);
        showNotification("Item name cannot exceed 50 characters!", "error");
    }
});

// ALSO FOR OCR MANUAL REVIEW (when user edits name)
document.addEventListener('input', function(e) {
    if (e.target && e.target.closest('.ocr-item') && e.target.type === 'text' && e.target.value.length > 30) {
        e.target.value = e.target.value.slice(0, 50);
        showNotification("Item name limited to 50 chars!", "error");
    }
});
    document.getElementById('expenseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        if (isNaN(amount) || amount <= 0) { showNotification("Amount must be greater than 0!", "error"); return; }
        const data = {
            item_name: document.getElementById('expenseItem').value,
            amount: amount,
            type: document.getElementById('expenseType').value,
            category: document.getElementById('expenseCategory').value,
            date: document.getElementById('expenseDate').value
        };
        fetch("/add_expense/", { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") }, body: JSON.stringify(data) })
        .then(() => { this.reset(); document.getElementById('expenseDate').value = today; updateCategories(); updateDashboardStats(); updateCharts(); loadTransactions(); showNotification("Transaction Added!"); });
    });


    // Borrow/Lend Form Submit
    document.getElementById('borrowLendForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const transDate = document.getElementById('blDate').value;
        const dueDate = document.getElementById('dueDate').value;
        if (dueDate && dueDate < transDate) {
            showNotification("Due date cannot be before transaction date!", "error");
            return;
        }
        const amount = parseFloat(document.getElementById('blAmount').value);
        if (isNaN(amount) || amount <= 0) { showNotification("Amount must be greater than 0!", "error"); return; }
        const data = { 
            person: document.getElementById('personName').value, 
            amount: amount, 
            type: document.getElementById('blType').value, 
            date: transDate, 
            dueDate: dueDate || null
        };
        fetch("/add-lend-borrow/", { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") }, body: JSON.stringify(data) })
        .then(() => { this.reset(); document.getElementById('blDate').value = today; loadLendBorrowRecords(); updateDashboardStats(); showNotification("Record added!"); });
    });

    // OCR, EDIT, DELETE, LOAD FUNCTIONS — 100% ORIGINAL & WORKING
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const imageUpload = document.getElementById("imageUpload");
    const processBtn = document.getElementById("processBtn");
    const canvasHint = document.getElementById("canvasHint");
    let img = new Image(), rectangles = [], isDrawing = false, startX, startY;

    imageUpload.addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        
        // FILE SIZE VALIDATION: Check if file is greater than 1MB (1,048,576 bytes)
        const maxFileSize = 1 * 1024 * 1024; // 1MB in bytes
        if (file.size > maxFileSize) {
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            showNotification(`Error: File size (${fileSizeMB}MB) exceeds 1MB limit. Please upload a smaller image.`, "error");
            imageUpload.value = ""; // Clear the file input
            canvas.classList.add("hidden");
            canvasHint.textContent = "Your image will appear here. Draw rectangles using mouse.";
            return;
        }
        
        const reader = new FileReader();
        reader.onload = ev => {
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.classList.remove("hidden");
                canvasHint.textContent = "Draw rectangles: 1 for items, 1 for amounts";
                redraw();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    });

    canvas.addEventListener("mousedown", e => {
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        isDrawing = true;
    });

    canvas.addEventListener("mousemove", e => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = Math.min(startX, e.clientX - rect.left);
        const y = Math.min(startY, e.clientY - rect.top);
        const w = Math.abs(e.clientX - rect. left - startX);
        const h = Math.abs(e.clientY - rect.top - startY);
        redraw();
        ctx.strokeStyle = "#3498db";
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, w, h);
    });

    canvas.addEventListener("mouseup", e => {
        if (isDrawing) {
            const rect = canvas.getBoundingClientRect();
            rectangles.push({
                x: Math.min(startX, e.clientX - rect.left),
                y: Math.min(startY, e.clientY - rect.top),
                width: Math.abs(e.clientX - rect.left - startX),
                height: Math.abs(e.clientY - rect.top - startY)
            });
            isDrawing = false;
            redraw();
            canvasHint.textContent = `Drew ${rectangles.length} rectangle(s). Ready!`;
        }
    });

    function redraw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        ctx.strokeStyle = "red";
        ctx.lineWidth = 2;
        rectangles.forEach(r => ctx.strokeRect(r.x, r.y, r.width, r.height));
    }

    document.getElementById("uploadForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        if (rectangles.length < 2) { alert("Please draw at least 2 rectangles!"); return; }
        processBtn.disabled = true;
        processBtn.innerHTML = 'Processing... <span class="spinner"></span>';
        const formData = new FormData();
        formData.append("image", imageUpload.files[0]);
        formData.append("rectangles", JSON.stringify(rectangles));
        try {
            const response = await fetch("/upload/", { method: "POST", headers: { "X-CSRFToken": getCookie("csrftoken") }, body: formData });
            const result = await response.json();
            if (response.ok && Array.isArray(result)) {
                showNotification(`Success! Added ${result.length} expense(s)!`, "success");
                updateDashboardStats(); updateCharts(); loadTransactions();
            } else {
                // Display server-side error message
                const errorMsg = result.error || "OCR failed. Try again.";
                showNotification(errorMsg, "error");
            }
        } catch (err) { 
            showNotification("Network error. Please try again.", "error"); 
        }
        finally {
            processBtn.disabled = false; processBtn.innerHTML = "Process Image";
            canvas.classList.add("hidden"); canvasHint.textContent = "Your image will appear here. Draw rectangles using mouse.";
            rectangles = []; imageUpload.value = "";
        }
    });

    function loadLendBorrowRecords() {
        fetch("/lend-borrow/").then(r => r.json()).then(d => {
            const tbody = document.getElementById('borrowLendTable');
            tbody.innerHTML = d.records.length === 0 
                ? `<tr><td colspan="7" style="text-align:center;padding:60px;color:#999;">No records yet</td></tr>`
                : d.records.map(r => `
                    <tr>
                        <td>${r.person}</td>
                        <td>${r.type==='lent' ? '+' : '-'}₹${parseFloat(r.amount).toFixed(2)}</td>
                        <td>${r.type.charAt(0).toUpperCase() + r.type.slice(1)}</td>
                        <td>${r.date}</td>
                        <td>${r.dueDate || 'N/A'}</td>
                        <td><span style="background:${r.status==='settled'?'#27ae60':'#e74c3c'};color:white;padding:3px 8px;border-radius:4px;">${r.status.charAt(0).toUpperCase() + r.status.slice(1)}</span></td>
                        <td>
                            ${r.status === 'pending' 
                                ? `<button class="btn btn-primary" style="padding:4px 8px;font-size:11px;" onclick="markSettled(${r.id})">Settle</button>`
                                : `<button class="btn btn-danger" style="padding:4px 8px;font-size:11px;" onclick="deleteLendBorrow(${r.id})">Delete</button>`
                            }
                        </td>
                    </tr>
                `).join('');
        });
    }

    function markSettled(id) { 
        fetch(`/update-lend-borrow/${id}/`, { method: "PATCH", headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") }, body: JSON.stringify({ status: "settled" }) })
        .then(() => { loadLendBorrowRecords(); updateDashboardStats(); showNotification("Settled!"); }); 
    }
    function deleteLendBorrow(id) { 
        if (confirm("Delete?")) fetch(`/update-lend-borrow/${id}/`, { method: "DELETE", headers: { "X-CSRFToken": getCookie("csrftoken") } })
        .then(() => { loadLendBorrowRecords(); updateDashboardStats(); showNotification("Deleted!"); }); 
    }

    function loadTransactions() {
        fetch("/dashboard/").then(r => r.text()).then(html => {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const rows = doc.querySelectorAll('#transactionsTable tr');
            const tbody = document.getElementById('transactionsTable');
            tbody.innerHTML = '';
            if (rows.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:60px;color:#999;">No transactions yet.</td></tr>`; return; }
            rows.forEach(row => {
                const id = row.id.split('-')[1]; if (!id) return;
                const cells = row.children;
                const newRow = document.createElement('tr'); newRow.id = `row-${id}`;
                newRow.innerHTML = `
                    <td class="editable" data-field="item_name">${cells[0].textContent}</td>
                    <td class="editable" data-field="amount">₹${cells[1].textContent.replace('₹', '')}</td>
                    <td class="editable" data-field="type">${cells[2].textContent}</td>
                    <td class="editable" data-field="category">${cells[3].textContent}</td>
                    <td class="editable" data-field="date">${cells[4].textContent}</td>
                    <td>
                        <button class="btn btn-primary" style="padding:5px 10px;font-size:12px;" onclick="enableEdit(${id})">Edit</button>
                        <button class="btn btn-danger" style="padding:5px 10px;font-size:12px;" onclick="deleteExpense(${id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(newRow);
            });
        });
    }

    function enableEdit(id) {
        const row = document.getElementById(`row-${id}`);
        const cells = row.querySelectorAll('.editable');
        cells.forEach(cell => {
            const field = cell.dataset.field;
            const value = cell.textContent.trim().replace('₹', '');
            let input = '';
            if (field === 'amount') input = `<input type="number" value="${value}" step="0.01" style="width:80px;">`;
            else if (field === 'date') input = `<input type="date" value="${value}">`;
            else if (field === 'type') input = `<select><option value="Income" ${value==='Income'?'selected':''}>Income</option><option value="Expense" ${value==='Expense'?'selected':''}>Expense</option></select>`;
            else input = `<input type="text" value="${value}">`;
            cell.innerHTML = input;
            cell.classList.add('editing');
        });
        row.querySelector('button').textContent = 'Save';
        row.querySelector('button').onclick = () => saveEdit(id);
    }

    function saveEdit(id) {
        const row = document.getElementById(`row-${id}`);
        const inputs = row.querySelectorAll('.editing input, .editing select');
        const data = {};
        inputs.forEach(input => {
            const field = input.parentElement.dataset.field;
            let value = input.value;
            if (field === 'amount') value = parseFloat(value);
            data[field] = value;
        });
        fetch(`/edit-expense/${id}/`, { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") }, body: JSON.stringify(data) })
        .then(() => { loadTransactions(); updateDashboardStats(); updateCharts(); showNotification("Updated!"); });
    }

    function deleteExpense(id) {
    Swal.fire({
    title: 'Are you sure?',
    text: "This action cannot be undone!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, delete it',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
       fetch(`/delete-expense/${id}/`, { method: "DELETE", headers: { "X-CSRFToken": getCookie("csrftoken") } })
        .then(() => { loadTransactions(); updateDashboardStats(); updateCharts(); showNotification("Deleted!"); });
    }
  }).then(() => {
     Swal.fire({
        title: "Deleted!",
        text: "Expense removed successfully.",
        icon: "success",
        timer: 1500,
        showConfirmButton: false
      });
  });
       
    }

    const expenseCategories = ["Food", "Travel", "Shopping", "Bills", "Health", "Entertainment", "Other"];
    const incomeCategories = ["Salary", "Freelance", "Investments", "Business", "Other"];
    const typeSelect = document.getElementById("expenseType");
    const categorySelect = document.getElementById("expenseCategory");

    function updateCategories() {
        const selectedType = typeSelect.value;
        const options = selectedType === "Expense" ? expenseCategories : incomeCategories;
        categorySelect.innerHTML = `<option value="">Select Category</option>` + 
            options.map(c => `<option value="${c}">${c}</option>`).join("");
    }
    typeSelect.addEventListener("change", updateCategories);

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById('expenseDate').value = today;
        document.getElementById('blDate').value = today;
        updateCategories();
        updateDashboardStats();
        updateCharts();
        loadTransactions();
        loadLendBorrowRecords();
    });
</script>
</body>
</html>