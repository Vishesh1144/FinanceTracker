{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'finance/layout.css' %}">
</head>
<body>
<div class="container">

    <!-- HEADER WITH USER INFO & LOGOUT -->
    <div class="header" style="position:relative; padding: 25px 30px;">
        <h1>Personal Finance Tracker</h1>
        <div style="position:absolute; top:20px; right:30px; display:flex; align-items:center; gap:15px; color:white; font-size:16px;">
            <span>Welcome, <strong>{{ user.username|title }}</strong>!</span>
            <form action="{% url 'logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger" style="padding:8px 16px; font-size:14px; margin:0;">
                    Logout
                </button>
            </form>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
        <button class="nav-tab" onclick="showTab('add-expense')">Add Expense</button>
        <button class="nav-tab" onclick="showTab('borrow-lend')">Borrow & Lend</button>
        <button class="nav-tab" onclick="showTab('transactions')">Transactions</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card income"><div class="stat-value" id="totalIncome">₹0.00</div><div class="stat-label">Total Income</div></div>
            <div class="stat-card expense"><div class="stat-value" id="totalExpense">₹0.00</div><div class="stat-label">Total Expenses</div></div>
            <div class="stat-card savings"><div class="stat-value" id="totalSavings">₹0.00</div><div class="stat-label">Net Savings</div></div>
            <div class="stat-card"><div class="stat-value" id="borrowLendBalance">₹0.00</div><div class="stat-label">Borrow/Lend Balance</div></div>
        </div>
        <div class="charts-container">
            <div class="chart-card"><canvas id="expenseChart"></canvas></div>
            <div class="chart-card"><canvas id="trendChart"></canvas></div>
        </div>
    </div>

    <!-- ADD EXPENSE -->
    <div id="add-expense" class="tab-content">
        <div class="form-container">
            <h2>Add New Transaction</h2>
            <form id="expenseForm">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group"><label for="expenseItem">Item Name</label><input type="text" id="expenseItem" required></div>
                    <div class="form-group"><label for="expenseAmount">Amount (₹)</label><input type="number" id="expenseAmount" step="0.01" required></div>
                    <div class="form-group">
                        <label for="expenseType">Type</label>
                        <select id="expenseType" required>
                            <option value="">Select Type</option>
                            <option value="Expense">Expense</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseCategory">Category</label>
                        <select id="expenseCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="expenseDate">Date</label><input type="date" id="expenseDate" required></div>
                </div>
                <div class="form-group"><label for="expenseNotes">Notes</label><textarea id="expenseNotes" rows="3"></textarea></div>
                <button type="submit" class="btn btn-primary">Add Transaction</button>
            </form>

            <br><h3>OR – Upload Bill (OCR)</h3>
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="imageUpload">Bill Image</label>
                    <div class="file-upload">
                        <input type="file" id="imageUpload" name="image" accept="image/*">
                        <div class="file-upload-btn">Click to upload</div>
                    </div>
                </div>
                <canvas id="canvas" class="hidden"></canvas>
                <button type="submit" class="btn btn-primary">Process Image</button>
            </form>
        </div>
    </div>

    <!-- BORROW & LEND -->
    <div id="borrow-lend" class="tab-content">
        <div class="form-container">
            <h2>Borrow & Lend Money</h2>
            <form id="borrowLendForm">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group"><label for="personName">Person Name</label><input type="text" id="personName" required></div>
                    <div class="form-group"><label for="blAmount">Amount (₹)</label><input type="number" id="blAmount" step="0.01" required></div>
                    <div class="form-group">
                        <label for="blType">Type</label>
                        <select id="blType" required>
                            <option value="">Select</option>
                            <option value="lent">Lent (They Owe Me)</option>
                            <option value="borrowed">Borrowed (I Owe)</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="blDate">Date</label><input type="date" id="blDate" required></div>
                    <div class="form-group"><label for="dueDate">Due Date</label><input type="date" id="dueDate"></div>
                </div>
                <div class="form-group"><label for="blReason">Reason</label><textarea id="blReason" rows="3"></textarea></div>
                <button type="submit" class="btn btn-primary">Add Record</button>
            </form>
        </div>
        <div class="transactions-table">
            <table class="table">
                <thead><tr><th>Person</th><th>Amount</th><th>Type</th><th>Date</th><th>Due</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="borrowLendTable"><tr><td colspan="7" class="empty-state"><h3>No Records</h3><p>Add above</p></td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- TRANSACTIONS -->
    <div id="transactions" class="tab-content">
        <div class="transactions-table">
            <table class="table">
                <thead><tr><th>Item</th><th>Amount</th><th>Type</th><th>Category</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="transactionsTable">
                    {% for expense in expenses %}
                    <tr id="row-{{ expense.id }}">
                        <td class="editable" data-field="item_name">{{ expense.item_name }}</td>
                        <td class="editable" data-field="amount">₹{{ expense.amount }}</td>
                        <td class="editable" data-field="type">{{ expense.type }}</td>
                        <td class="editable" data-field="category">{{ expense.category }}</td>
                        <td class="editable" data-field="date">{{ expense.date }}</td>
                        <td>
                            <button class="btn btn-primary" style="padding:5px 10px;font-size:12px;" onclick="enableEdit({{ expense.id }})">Edit</button>
                            <button class="btn btn-danger" style="padding:5px 10px;font-size:12px;" onclick="deleteExpense({{ expense.id }})">Delete</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="empty-state">No transactions yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Tab Switching
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        if (tabName === 'borrow-lend') loadLendBorrowRecords();
        if (tabName === 'transactions') loadTransactions();
    }

    // Notification
    function showNotification(msg, type = 'success') {
        const n = document.createElement('div');
        n.className = `notification ${type}`;
        n.textContent = msg;
        document.body.appendChild(n);
        setTimeout(() => n.classList.add('show'), 100);
        setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 300); }, 3000);
    }

    // Set Today
    function setToday() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('expenseDate').value = today;
        document.getElementById('blDate').value = today;
    }

    // Charts
    const expenseChart = new Chart(document.getElementById('expenseChart'), { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#f87171','#60a5fa','#34d399','#fbbf24','#a78bfa','#f472b6'] }] }, options: { responsive: true } });
    const trendChart = new Chart(document.getElementById('trendChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Income', data: [], borderColor: '#34d399' }, { label: 'Expense', data: [], borderColor: '#f87171' }] }, options: { responsive: true } });

    function updateCharts() {
        fetch("/get_chart_data/").then(r => r.json()).then(d => {
            expenseChart.data.labels = Object.keys(d.categories);
            expenseChart.data.datasets[0].data = Object.values(d.categories);
            expenseChart.update();
            trendChart.data.labels = d.months;
            trendChart.data.datasets[0].data = d.income;
            trendChart.data.datasets[1].data = d.expense;
            trendChart.update();
        });
    }

    function updateDashboardStats() {
        fetch("/get_totals/").then(r => r.json()).then(d => {
            document.getElementById("totalIncome").textContent = `₹${d.total_income.toFixed(2)}`;
            document.getElementById("totalExpense").textContent = `₹${d.total_expense.toFixed(2)}`;
            document.getElementById("totalSavings").textContent = `₹${d.total_savings.toFixed(2)}`;
        });
        fetch("/lend-borrow/").then(r => r.json()).then(d => {
            const balance = d.records.filter(r => r.status === 'pending').reduce((s, r) => r.type === 'lent' ? s + r.amount : s - r.amount, 0);
            document.getElementById("borrowLendBalance").textContent = balance >= 0 ? `+₹${balance.toFixed(2)}` : `-₹${Math.abs(balance).toFixed(2)}`;
        });
    }

    // Add Expense
    document.getElementById('expenseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const data = {
            item_name: document.getElementById('expenseItem').value,
            amount: parseFloat(document.getElementById('expenseAmount').value),
            type: document.getElementById('expenseType').value,
            category: document.getElementById('expenseCategory').value,
            date: document.getElementById('expenseDate').value
        };
        fetch("/add_expense/", { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") }, body: JSON.stringify(data) })
        .then(() => { this.reset(); setToday(); updateCategories(); updateDashboardStats(); updateCharts(); loadTransactions(); showNotification("Added!"); });
    });

    // OCR Canvas (unchanged)
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const imageUpload = document.getElementById("imageUpload");
    let img = new Image(), rectangles = [], isDrawing = false, startX, startY;

    imageUpload.addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            img.onload = () => { canvas.width = img.width; canvas.height = img.height; canvas.classList.remove("hidden"); redraw(); };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    });

    canvas.addEventListener("mousedown", e => { const rect = canvas.getBoundingClientRect(); startX = e.clientX - rect.left; startY = e.clientY - rect.top; isDrawing = true; });
    canvas.addEventListener("mousemove", e => { if (!isDrawing) return; const rect = canvas.getBoundingClientRect(); const x = Math.min(startX, e.clientX - rect.left); const y = Math.min(startY, e.clientY - rect.top); const w = Math.abs(e.clientX - rect.left - startX); const h = Math.abs(e.clientY - rect.top - startY); redraw(); ctx.strokeStyle = "blue"; ctx.lineWidth = 3; ctx.strokeRect(x, y, w, h); });
    canvas.addEventListener("mouseup", () => { if (isDrawing) { rectangles.push({ x: Math.min(startX, event.clientX - canvas.getBoundingClientRect().left), y: Math.min(startY, event.clientY - canvas.getBoundingClientRect().top), width: Math.abs(event.clientX - canvas.getBoundingClientRect().left - startX), height: Math.abs(event.clientY - canvas.getBoundingClientRect().top - startY) }); isDrawing = false; redraw(); } });

    function redraw() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); ctx.strokeStyle = "red"; ctx.lineWidth = 2; rectangles.forEach(r => ctx.strokeRect(r.x, r.y, r.width, r.height)); }

    document.getElementById("uploadForm").addEventListener("submit", e => {
        e.preventDefault();
        if (rectangles.length === 0) return alert("Draw rectangles first!");
        const formData = new FormData();
        formData.append("image", imageUpload.files[0]);
        formData.append("rectangles", JSON.stringify(rectangles));
        fetch("/upload/", { method: "POST", headers: { "X-CSRFToken": getCookie("csrftoken") }, body: formData })
        .then(r => r.json())
        .then(() => { showNotification("OCR Processed!"); updateDashboardStats(); updateCharts(); loadTransactions(); canvas.classList.add("hidden"); rectangles = []; imageUpload.value = ""; });
    });

    // LEND & BORROW (unchanged)
    function loadLendBorrowRecords() {
        fetch("/lend-borrow/").then(r => r.json()).then(d => {
            const tbody = document.getElementById('borrowLendTable');
            tbody.innerHTML = d.records.length === 0 ? `<tr><td colspan="7" class="empty-state"><h3>No Records</h3><p>Add above</p></td></tr>` : d.records.map(r => `
                <tr>
                    <td>${r.person}</td>
                    <td class="${r.type==='lent'?'amount-positive':'amount-negative'}">${r.type==='lent'?'+' : '-'}₹${parseFloat(r.amount).toFixed(2)}</td>
                    <td>${r.type.charAt(0).toUpperCase() + r.type.slice(1)}</td>
                    <td>${r.date}</td>
                    <td>${r.dueDate || 'N/A'}</td>
                    <td><span class="badge" style="background:${r.type==='settled'?'#27ae60':'#e74c3c'};color:white;">${r.status.charAt(0).toUpperCase() + r.status.slice(1)}</span></td>
                    <td>${r.status === 'pending' ? `<button class="btn btn-primary" style="padding:5px;font-size:12px;" onclick="markSettled(${r.id})">Settle</button>` : `<button class="btn btn-danger" style="padding:5px;font-size:12px;" onclick="deleteLendBorrow(${r.id})">Delete</button>`}</td>
                </tr>
            `).join('');
        });
    }

    document.getElementById('borrowLendForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const data = { person: document.getElementById('personName').value, amount: parseFloat(document.getElementById('blAmount').value), type: document.getElementById('blType').value, date: document.getElementById('blDate').value, dueDate: document.getElementById('dueDate').value || null, reason: document.getElementById('blReason').value };
        fetch("/add-lend-borrow/", { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") }, body: JSON.stringify(data) })
        .then(() => { this.reset(); setToday(); loadLendBorrowRecords(); updateDashboardStats(); showNotification("Record added!"); });
    });

    function markSettled(id) { fetch(`/update-lend-borrow/${id}/`, { method: "PATCH", headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") }, body: JSON.stringify({ status: "settled" }) }).then(() => { loadLendBorrowRecords(); updateDashboardStats(); showNotification("Settled!"); }); }
    function deleteLendBorrow(id) { if (confirm("Delete?")) fetch(`/update-lend-borrow/${id}/`, { method: "DELETE", headers: { "X-CSRFToken": getCookie("csrftoken") } }).then(() => { loadLendBorrowRecords(); updateDashboardStats(); showNotification("Deleted!"); }); }

    // TRANSACTIONS (unchanged)
    function loadTransactions() {
        fetch("/dashboard/").then(r => r.text()).then(html => {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const rows = doc.querySelectorAll('#transactionsTable tr');
            const tbody = document.getElementById('transactionsTable');
            tbody.innerHTML = '';
            if (rows.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="empty-state">No transactions yet.</td></tr>`; return; }
            rows.forEach(row => {
                const id = row.id.split('-')[1]; if (!id) return;
                const cells = row.children;
                const newRow = document.createElement('tr'); newRow.id = `row-${id}`;
                newRow.innerHTML = `
                    <td class="editable" data-field="item_name">${cells[0].textContent}</td>
                    <td class="editable" data-field="amount">₹${cells[1].textContent.replace('₹', '')}</td>
                    <td class="editable" data-field="type">${cells[2].textContent}</td>
                    <td class="editable" data-field="category">${cells[3].textContent}</td>
                    <td class="editable" data-field="date">${cells[4].textContent}</td>
                    <td>
                        <button class="btn btn-primary" style="padding:5px 10px;font-size:12px;" onclick="enableEdit(${id})">Edit</button>
                        <button class="btn btn-danger" style="padding:5px 10px;font-size:12px;" onclick="deleteExpense(${id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(newRow);
            });
        });
    }

    function enableEdit(id) {
        const row = document.getElementById(`row-${id}`);
        const cells = row.querySelectorAll('.editable');
        cells.forEach(cell => {
            const field = cell.dataset.field;
            const value = cell.textContent.trim().replace('₹', '');
            let input = '';
            if (field === 'amount') input = `<input type="number" value="${value}" step="0.01" style="width:80px;">`;
            else if (field === 'date') input = `<input type="date" value="${value}">`;
            else if (field === 'type') input = `<select><option value="Income" ${value==='Income'?'selected':''}>Income</option><option value="Expense" ${value==='Expense'?'selected':''}>Expense</option></select>`;
            else input = `<input type="text" value="${value}">`;
            cell.innerHTML = input;
            cell.classList.add('editing');
        });
        row.querySelector('button').textContent = 'Save';
        row.querySelector('button').onclick = () => saveEdit(id);
    }

    function saveEdit(id) {
        const row = document.getElementById(`row-${id}`);
        const inputs = row.querySelectorAll('.editing input, .editing select');
        const data = {};
        inputs.forEach(input => {
            const field = input.parentElement.dataset.field;
            let value = input.value;
            if (field === 'amount') value = parseFloat(value);
            data[field] = value;
        });
        fetch(`/edit-expense/${id}/`, { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") }, body: JSON.stringify(data) })
        .then(() => { loadTransactions(); updateDashboardStats(); updateCharts(); showNotification("Updated!"); });
    }

    function deleteExpense(id) {
        if (!confirm("Delete this expense?")) return;
        fetch(`/delete-expense/${id}/`, { method: "DELETE", headers: { "X-CSRFToken": getCookie("csrftoken") } })
        .then(() => { loadTransactions(); updateDashboardStats(); updateCharts(); showNotification("Deleted!"); });
    }

    // DYNAMIC CATEGORIES
    const expenseCategories = ["Food", "Travel", "Shopping", "Bills", "Health", "Entertainment", "Other"];
    const incomeCategories = ["Salary", "Freelance", "Investments", "Business", "Other"];
    const typeSelect = document.getElementById("expenseType");
    const categorySelect = document.getElementById("expenseCategory");

    function updateCategories() {
        const selectedType = typeSelect.value;
        let options = [];
        if (selectedType === "Expense") options = expenseCategories;
        else if (selectedType === "Income") options = incomeCategories;

        categorySelect.innerHTML = `<option value="">Select Category</option>` + 
            options.map(c => `<option value="${c}">${c}</option>`).join("");
    }

    typeSelect.addEventListener("change", updateCategories);

    // INIT
    document.addEventListener("DOMContentLoaded", () => {
        setToday();
        updateCategories();
        updateDashboardStats();
        updateCharts();
        loadTransactions();
    });
</script>
</body>
</html>